---
ms.date: 06/11/2020
keywords: powershell, cmdlet
title: WinRMSecurity
ms.openlocfilehash: ee7e5f2c9c9a863e29c9278c40703a05c1943246
ms.sourcegitcommit: fd223afa50092839c74d8d5fbba791869665455f
ms.translationtype: HT
ms.contentlocale: pt-BR
ms.lasthandoff: 06/25/2020
ms.locfileid: "85353831"
---
# <a name="powershell-remoting-security-considerations"></a><span data-ttu-id="3f9f7-103">Considerações de segurança de comunicação remota do PowerShell</span><span class="sxs-lookup"><span data-stu-id="3f9f7-103">PowerShell Remoting Security Considerations</span></span>

<span data-ttu-id="3f9f7-104">Comunicação remota do PowerShell é a maneira recomendada de gerenciar sistemas Windows.</span><span class="sxs-lookup"><span data-stu-id="3f9f7-104">PowerShell Remoting is the recommended way to manage Windows systems.</span></span> <span data-ttu-id="3f9f7-105">A comunicação remota do PowerShell é habilitada por padrão no Windows Server 2012 R2.</span><span class="sxs-lookup"><span data-stu-id="3f9f7-105">PowerShell Remoting is enabled by default in Windows Server 2012 R2.</span></span> <span data-ttu-id="3f9f7-106">Este documento aborda questões, recomendações e práticas recomendadas de segurança ao usar a comunicação remota do PowerShell.</span><span class="sxs-lookup"><span data-stu-id="3f9f7-106">This document covers security concerns, recommendations, and best practices when using PowerShell Remoting.</span></span>

## <a name="what-is-powershell-remoting"></a><span data-ttu-id="3f9f7-107">O que é a comunicação remota do PowerShell?</span><span class="sxs-lookup"><span data-stu-id="3f9f7-107">What is PowerShell Remoting?</span></span>

<span data-ttu-id="3f9f7-108">A comunicação remota do PowerShell usa o [WinRM (Gerenciamento Remoto do Windows)](/windows/win32/winrm/portal), que é a implementação do protocolo [WS-Management (Serviços Web para Gerenciamento)](https://www.dmtf.org/sites/default/files/standards/documents/DSP0226_1.2.0.pdf) da Microsoft, para permitir que os usuários executem comandos do PowerShell em computadores remotos.</span><span class="sxs-lookup"><span data-stu-id="3f9f7-108">PowerShell Remoting uses [Windows Remote Management (WinRM)](/windows/win32/winrm/portal), which is the Microsoft implementation of the [Web Services for Management (WS-Management)](https://www.dmtf.org/sites/default/files/standards/documents/DSP0226_1.2.0.pdf) protocol, to allow users to run PowerShell commands on remote computers.</span></span> <span data-ttu-id="3f9f7-109">Você pode encontrar mais informações sobre como usar a comunicação remota do PowerShell em [Executando comandos remotos](running-remote-commands.md).</span><span class="sxs-lookup"><span data-stu-id="3f9f7-109">You can find more information about using PowerShell Remoting at [Running Remote Commands](running-remote-commands.md).</span></span>

<span data-ttu-id="3f9f7-110">A comunicação remota do PowerShell não é igual ao parâmetro **ComputerName** de um cmdlet para executá-lo em um computador remoto, que usa RPC (Chamada de Procedimento Remoto) como seu protocolo subjacente.</span><span class="sxs-lookup"><span data-stu-id="3f9f7-110">PowerShell Remoting is not the same as using the **ComputerName** parameter of a cmdlet to run it on a remote computer, which uses Remote Procedure Call (RPC) as its underlying protocol.</span></span>

## <a name="powershell-remoting-default-settings"></a><span data-ttu-id="3f9f7-111">Configurações padrão de comunicação remota do PowerShell</span><span class="sxs-lookup"><span data-stu-id="3f9f7-111">PowerShell Remoting default settings</span></span>

<span data-ttu-id="3f9f7-112">A comunicação remota do PowerShell (e WinRM) escutam nas seguintes portas:</span><span class="sxs-lookup"><span data-stu-id="3f9f7-112">PowerShell Remoting (and WinRM) listen on the following ports:</span></span>

- <span data-ttu-id="3f9f7-113">HTTP: 5985</span><span class="sxs-lookup"><span data-stu-id="3f9f7-113">HTTP: 5985</span></span>
- <span data-ttu-id="3f9f7-114">HTTPS: 5986</span><span class="sxs-lookup"><span data-stu-id="3f9f7-114">HTTPS: 5986</span></span>

<span data-ttu-id="3f9f7-115">Por padrão, a comunicação remota do PowerShell só permite conexões de membros do grupo de Administradores.</span><span class="sxs-lookup"><span data-stu-id="3f9f7-115">By default, PowerShell Remoting only allows connections from members of the Administrators group.</span></span>
<span data-ttu-id="3f9f7-116">As sessões são iniciadas no contexto do usuário, de modo que todos os controles de acesso do sistema operacional aplicados a usuários individuais e grupos continuam a serem aplicados enquanto conectados via comunicação remota do PowerShell.</span><span class="sxs-lookup"><span data-stu-id="3f9f7-116">Sessions are launched under the user's context, so all operating system access controls applied to individual users and groups continue to apply to them while connected over PowerShell Remoting.</span></span>

<span data-ttu-id="3f9f7-117">Em redes privadas, a regra de Firewall do Windows padrão para comunicação remota do PowerShell aceita todas as conexões.</span><span class="sxs-lookup"><span data-stu-id="3f9f7-117">On private networks, the default Windows Firewall rule for PowerShell Remoting accepts all connections.</span></span> <span data-ttu-id="3f9f7-118">Em redes públicas, a regra padrão do Firewall do Windows permite as conexões da comunicação remota do PowerShell somente dentro da mesma sub-rede.</span><span class="sxs-lookup"><span data-stu-id="3f9f7-118">On public networks, the default Windows Firewall rule allows PowerShell Remoting connections only from within the same subnet.</span></span> <span data-ttu-id="3f9f7-119">Você precisa alterar explicitamente a regra para abrir a comunicação remota do PowerShell para todas as conexões em uma rede pública.</span><span class="sxs-lookup"><span data-stu-id="3f9f7-119">You have to explicitly change that rule to open PowerShell Remoting to all connections on a public network.</span></span>

> [!Warning]
> <span data-ttu-id="3f9f7-120">a regra de firewall para redes públicas destina-se a proteger o computador contra tentativas de conexão externa potencialmente mal-intencionada.</span><span class="sxs-lookup"><span data-stu-id="3f9f7-120">The firewall rule for public networks is meant to protect the computer from potentially malicious external connection attempts.</span></span> <span data-ttu-id="3f9f7-121">Tenha cuidado ao remover essa regra.</span><span class="sxs-lookup"><span data-stu-id="3f9f7-121">Use caution when removing this rule.</span></span>

## <a name="process-isolation"></a><span data-ttu-id="3f9f7-122">Isolamento do processo</span><span class="sxs-lookup"><span data-stu-id="3f9f7-122">Process isolation</span></span>

<span data-ttu-id="3f9f7-123">A comunicação remota do PowerShell usa o WinRM para a comunicação entre computadores.</span><span class="sxs-lookup"><span data-stu-id="3f9f7-123">PowerShell Remoting uses WinRM for communication between computers.</span></span> <span data-ttu-id="3f9f7-124">O WinRM é executado como um serviço na conta de serviço de rede e gera processos isolados executados como contas de usuário para hospedar instâncias do PowerShell.</span><span class="sxs-lookup"><span data-stu-id="3f9f7-124">WinRM runs as a service under the Network Service account, and spawns isolated processes running as user accounts to host PowerShell instances.</span></span> <span data-ttu-id="3f9f7-125">Uma instância do PowerShell em execução como um usuário não tem acesso a um processo que executa uma instância do PowerShell como outro usuário.</span><span class="sxs-lookup"><span data-stu-id="3f9f7-125">An instance of PowerShell running as one user has no access to a process running an instance of PowerShell as another user.</span></span>

## <a name="event-logs-generated-by-powershell-remoting"></a><span data-ttu-id="3f9f7-126">Logs de eventos gerados pela comunicação remota do PowerShell</span><span class="sxs-lookup"><span data-stu-id="3f9f7-126">Event logs generated by PowerShell Remoting</span></span>

<span data-ttu-id="3f9f7-127">O FireEye forneceu um bom resumo dos logs de eventos e outras evidências de segurança gerados pelas sessões remotas do PowerShell, disponíveis no white paper [Investigando ataques ao PowerShell](https://www.fireeye.com/content/dam/fireeye-www/global/en/solutions/pdfs/wp-lazanciyan-investigating-powershell-attacks.pdf).</span><span class="sxs-lookup"><span data-stu-id="3f9f7-127">FireEye has provided a good summary of the event logs and other security evidence generated by PowerShell Remoting sessions, available at [Investigating PowerShell Attacks](https://www.fireeye.com/content/dam/fireeye-www/global/en/solutions/pdfs/wp-lazanciyan-investigating-powershell-attacks.pdf).</span></span>

## <a name="encryption-and-transport-protocols"></a><span data-ttu-id="3f9f7-128">Protocolos de transporte e criptografia</span><span class="sxs-lookup"><span data-stu-id="3f9f7-128">Encryption and transport protocols</span></span>

<span data-ttu-id="3f9f7-129">Vale a pena considerar a segurança de uma conexão de comunicação remota do PowerShell de duas perspectivas: autenticação inicial e comunicação em andamento.</span><span class="sxs-lookup"><span data-stu-id="3f9f7-129">It is helpful to consider the security of a PowerShell Remoting connection from two perspectives: initial authentication, and ongoing communication.</span></span>

<span data-ttu-id="3f9f7-130">Independentemente do protocolo de transporte usado (HTTP ou HTTPS), o WinRM sempre criptografa toda a comunicação remota do PowerShell após a autenticação inicial.</span><span class="sxs-lookup"><span data-stu-id="3f9f7-130">Regardless of the transport protocol used (HTTP or HTTPS), WinRM always encrypts all PowerShell remoting communication after initial authentication.</span></span>

### <a name="initial-authentication"></a><span data-ttu-id="3f9f7-131">Autenticação inicial</span><span class="sxs-lookup"><span data-stu-id="3f9f7-131">Initial authentication</span></span>

<span data-ttu-id="3f9f7-132">A autenticação confirma a identidade do cliente para o servidor - e idealmente - do servidor para o cliente.</span><span class="sxs-lookup"><span data-stu-id="3f9f7-132">Authentication confirms the identity of the client to the server - and ideally - the server to the client.</span></span>

<span data-ttu-id="3f9f7-133">Quando um cliente se conecta a um servidor de domínio usando o nome do computador dele, o protocolo de autenticação padrão é [Kerberos](/windows/win32/secauthn/microsoft-kerberos).</span><span class="sxs-lookup"><span data-stu-id="3f9f7-133">When a client connects to a domain server using its computer name, the default authentication protocol is [Kerberos](/windows/win32/secauthn/microsoft-kerberos).</span></span> <span data-ttu-id="3f9f7-134">Kerberos garante a identidade do usuário e a identidade do servidor sem enviar qualquer tipo de credencial reutilizável.</span><span class="sxs-lookup"><span data-stu-id="3f9f7-134">Kerberos guarantees both the user identity and server identity without sending any sort of reusable credential.</span></span>

<span data-ttu-id="3f9f7-135">Quando um cliente se conecta a um servidor de domínio usando seu endereço IP, ou se conecta a um servidor de grupo de trabalho, a autenticação Kerberos não é possível.</span><span class="sxs-lookup"><span data-stu-id="3f9f7-135">When a client connects to a domain server using its IP address, or connects to a workgroup server, Kerberos authentication is not possible.</span></span> <span data-ttu-id="3f9f7-136">Nesse caso, a comunicação remoto do PowerShell depende do [protocolo de autenticação NTLM](/windows/win32/secauthn/microsoft-ntlm).</span><span class="sxs-lookup"><span data-stu-id="3f9f7-136">In that case, PowerShell Remoting relies on the [NTLM authentication protocol](/windows/win32/secauthn/microsoft-ntlm).</span></span> <span data-ttu-id="3f9f7-137">O protocolo de autenticação NTLM garante a identidade do usuário sem enviar qualquer tipo de credencial delegável.</span><span class="sxs-lookup"><span data-stu-id="3f9f7-137">The NTLM authentication protocol guarantees the user identity without sending any sort of delegable credential.</span></span> <span data-ttu-id="3f9f7-138">Para provar a identidade do usuário, o protocolo NTLM exige que o cliente e o servidor computem uma chave de sessão da senha do usuário sem nunca trocar a senha.</span><span class="sxs-lookup"><span data-stu-id="3f9f7-138">To prove user identity, the NTLM protocol requires that both the client and server compute a session key from the user's password without ever exchanging the password itself.</span></span> <span data-ttu-id="3f9f7-139">O servidor normalmente não sabe a senha do usuário, de modo que ele se comunica com o controlador de domínio, que sabe a senha do usuário e calcula a chave de sessão para o servidor.</span><span class="sxs-lookup"><span data-stu-id="3f9f7-139">The server typically does not know the user's password, so it communicates with the domain controller, which does know the user's password and calculates the session key for the server.</span></span>

<span data-ttu-id="3f9f7-140">No entanto, o protocolo NTLM não assegura a identidade do servidor.</span><span class="sxs-lookup"><span data-stu-id="3f9f7-140">The NTLM protocol does not, however, guarantee server identity.</span></span> <span data-ttu-id="3f9f7-141">Como ocorre com todos os protocolos que usam NTLM para autenticação, um invasor com acesso a uma conta do computador ingressado do domínio pode invocar o controlador de domínio para computar uma chave de sessão NTLM e, assim, representar o servidor.</span><span class="sxs-lookup"><span data-stu-id="3f9f7-141">As with all protocols that use NTLM for authentication, an attacker with access to a domain-joined computer's machine account could invoke the domain controller to compute an NTLM session-key and thereby impersonate the server.</span></span>

<span data-ttu-id="3f9f7-142">A autenticação baseada em NTLM está desabilitada por padrão, mas pode ser permitida ao configurar SSL no servidor de destino, ou ao definir a configuração de WinRM TrustedHosts no cliente.</span><span class="sxs-lookup"><span data-stu-id="3f9f7-142">NTLM-based authentication is disabled by default, but may be permitted by either configuring SSL on the target server, or by configuring the WinRM TrustedHosts setting on the client.</span></span>

#### <a name="using-ssl-certificates-to-validate-server-identity-during-ntlm-based-connections"></a><span data-ttu-id="3f9f7-143">Usando certificados SSL para validar a identidade do servidor durante conexões baseadas em NTLM</span><span class="sxs-lookup"><span data-stu-id="3f9f7-143">Using SSL certificates to validate server identity during NTLM-based connections</span></span>

<span data-ttu-id="3f9f7-144">Como o protocolo de autenticação NTLM não pode garantir a identidade do servidor de destino (somente que ele já sabe sua senha), você pode configurar servidores de destino para usar SSL na comunicação remota do PowerShell.</span><span class="sxs-lookup"><span data-stu-id="3f9f7-144">Since the NTLM authentication protocol cannot ensure the identity of the target server (only that it already knows your password), you can configure target servers to use SSL for PowerShell Remoting.</span></span>
<span data-ttu-id="3f9f7-145">Atribuir um certificado SSL ao servidor de destino (se emitido por uma autoridade de certificação em que o cliente também confia) permite a autenticação baseada em NTLM, que garante a identidade do usuário e do servidor.</span><span class="sxs-lookup"><span data-stu-id="3f9f7-145">Assigning a SSL certificate to the target server (if issued by a Certificate Authority that the client also trusts) enables NTLM-based authentication that guarantees both the user identity and server identity.</span></span>

#### <a name="ignoring-ntlm-based-server-identity-errors"></a><span data-ttu-id="3f9f7-146">Ignorando erros de identidade de servidor baseada em NTLM</span><span class="sxs-lookup"><span data-stu-id="3f9f7-146">Ignoring NTLM-based server identity errors</span></span>

<span data-ttu-id="3f9f7-147">Se for inviável implantar um certificado SSL em um servidor para conexões de NTLM, você poderá suprimir os erros de identidade resultantes adicionando o servidor à lista **TrustedHosts** do WinRM.</span><span class="sxs-lookup"><span data-stu-id="3f9f7-147">If deploying a SSL certificate to a server for NTLM connections is infeasible, you may suppress the resulting identity errors by adding the server to the WinRM **TrustedHosts** list.</span></span> <span data-ttu-id="3f9f7-148">Observe que a adição de um nome do servidor à lista **TrustedHosts** não deve ser considerada uma forma de declaração da confiabilidade dos próprios hosts, pois o protocolo de autenticação NTLM não pode garantir que você realmente esteja se conectando com o host com o qual pretende se conectar.</span><span class="sxs-lookup"><span data-stu-id="3f9f7-148">Please note that adding a server name to the **TrustedHosts** list should not be considered as any form of statement of the trustworthiness of the hosts themselves - as the NTLM authentication protocol cannot guarantee that you are in fact connecting to the host you are intending to connect to.</span></span> <span data-ttu-id="3f9f7-149">Em vez disso, você deve considerar a configuração TrustedHosts como a lista de hosts para a qual você deseja suprimir o erro gerado por não ter sido capaz de verificar a identidade do servidor.</span><span class="sxs-lookup"><span data-stu-id="3f9f7-149">Instead, you should consider the TrustedHosts setting to be the list of hosts for which you wish to suppress the error generated by being unable to verify the server's identity.</span></span>

### <a name="ongoing-communication"></a><span data-ttu-id="3f9f7-150">Comunicação em andamento</span><span class="sxs-lookup"><span data-stu-id="3f9f7-150">Ongoing Communication</span></span>

<span data-ttu-id="3f9f7-151">Depois que a autenticação inicial é concluída, o WinRM criptografa a comunicação em andamento.</span><span class="sxs-lookup"><span data-stu-id="3f9f7-151">Once initial authentication is complete, the WinRM encrypts the ongoing communication.</span></span> <span data-ttu-id="3f9f7-152">Na conexão por HTTPS, o protocolo TLS é usado para negociar a criptografia usada para transportar dados.</span><span class="sxs-lookup"><span data-stu-id="3f9f7-152">When connecting over HTTPS, the TLS protocol is used to negotiate the encryption used to transport data.</span></span>
<span data-ttu-id="3f9f7-153">Na conexão por HTTP, a criptografia no nível da mensagem é determinada pelo protocolo de autenticação inicial usado.</span><span class="sxs-lookup"><span data-stu-id="3f9f7-153">When connecting over HTTP, message-level encryption is determined by initial authentication protocol used.</span></span>

- <span data-ttu-id="3f9f7-154">A autenticação básica não fornece nenhuma criptografia.</span><span class="sxs-lookup"><span data-stu-id="3f9f7-154">Basic authentication provide no encryption.</span></span>
- <span data-ttu-id="3f9f7-155">A autenticação NTLM usa uma criptografia RC4 com uma chave de 128 bits.</span><span class="sxs-lookup"><span data-stu-id="3f9f7-155">NTLM authentication uses an RC4 cipher with a 128-bit key.</span></span>
- <span data-ttu-id="3f9f7-156">A criptografia de autenticação Kerberos é determinada pelo `etype` no tíquete TGS.</span><span class="sxs-lookup"><span data-stu-id="3f9f7-156">Kerberos authentication encryption is determined by the `etype` in the TGS ticket.</span></span> <span data-ttu-id="3f9f7-157">Esse é o AES-256 nos sistemas modernos.</span><span class="sxs-lookup"><span data-stu-id="3f9f7-157">This is AES-256 on modern systems.</span></span>
- <span data-ttu-id="3f9f7-158">A criptografia CredSSP usa o conjunto de criptografia TLS que foi negociado no handshake.</span><span class="sxs-lookup"><span data-stu-id="3f9f7-158">CredSSP encryption is uses the TLS cipher suite that was negotiated in the handshake.</span></span>

## <a name="making-the-second-hop"></a><span data-ttu-id="3f9f7-159">Dando o segundo salto</span><span class="sxs-lookup"><span data-stu-id="3f9f7-159">Making the second hop</span></span>

<span data-ttu-id="3f9f7-160">Por padrão, a comunicação remota do PowerShell usa o Kerberos (se disponível) ou o NTLM para autenticação.</span><span class="sxs-lookup"><span data-stu-id="3f9f7-160">By default, PowerShell Remoting uses Kerberos (if available) or NTLM for authentication.</span></span> <span data-ttu-id="3f9f7-161">Ambos os protocolos autenticam o computador remoto sem enviar as credenciais para ele.</span><span class="sxs-lookup"><span data-stu-id="3f9f7-161">Both of these protocols authenticate to the remote machine without sending credentials to it.</span></span> <span data-ttu-id="3f9f7-162">Essa é a maneira mais segura de autenticar, mas como o computador remoto não tem as credenciais do usuário, não é possível acessar outros computadores e serviços em nome do usuário.</span><span class="sxs-lookup"><span data-stu-id="3f9f7-162">This is the most secure way to authenticate, but because the remote machine does not have the user's credentials, it cannot access other computers and services on the user's behalf.</span></span> <span data-ttu-id="3f9f7-163">Isso é conhecido como o "problema do segundo salto".</span><span class="sxs-lookup"><span data-stu-id="3f9f7-163">This is known as the "second hop problem".</span></span>

<span data-ttu-id="3f9f7-164">Há várias maneiras de evitar esse problema.</span><span class="sxs-lookup"><span data-stu-id="3f9f7-164">There are several ways to avoid this problem.</span></span> <span data-ttu-id="3f9f7-165">Para obter descrições desses métodos e os prós e contras de cada um, consulte [Dando o segundo salto na Comunicação Remota do PowerShell](PS-remoting-second-hop.md).</span><span class="sxs-lookup"><span data-stu-id="3f9f7-165">For descriptions of these methods, and the pros and cons of each, see [Making the second hop in PowerShell Remoting](PS-remoting-second-hop.md).</span></span>

## <a name="references"></a><span data-ttu-id="3f9f7-166">Referências</span><span class="sxs-lookup"><span data-stu-id="3f9f7-166">References</span></span>

- [<span data-ttu-id="3f9f7-167">Gerenciamento Remoto do Windows (WinRM)</span><span class="sxs-lookup"><span data-stu-id="3f9f7-167">Windows Remote Management (WinRM)</span></span>](/windows/win32/winrm/portal)
- [<span data-ttu-id="3f9f7-168">Serviços Web para Gerenciamento (WS-Management)</span><span class="sxs-lookup"><span data-stu-id="3f9f7-168">Web Services for Management (WS-Management)</span></span>](https://www.dmtf.org/sites/default/files/standards/documents/DSP0226_1.2.0.pdf)
- [<span data-ttu-id="3f9f7-169">2.2.9.1 Tipos de mensagem de criptografia</span><span class="sxs-lookup"><span data-stu-id="3f9f7-169">2.2.9.1 Encrypted Message Types</span></span>](/openspecs/windows_protocols/ms-wsmv/58421aa4-861a-4410-831a-c999f094cdb7)
- [<span data-ttu-id="3f9f7-170">Kerberos</span><span class="sxs-lookup"><span data-stu-id="3f9f7-170">Kerberos</span></span>](/windows/win32/secauthn/microsoft-kerberos)
- [<span data-ttu-id="3f9f7-171">Protocolo de autenticação NTLM</span><span class="sxs-lookup"><span data-stu-id="3f9f7-171">NTLM authentication protocol</span></span>](/windows/win32/secauthn/microsoft-ntlm)
- [<span data-ttu-id="3f9f7-172">Como investigar os ataques do PowerShell</span><span class="sxs-lookup"><span data-stu-id="3f9f7-172">Investigating PowerShell Attacks</span></span>](https://www.fireeye.com/content/dam/fireeye-www/global/en/solutions/pdfs/wp-lazanciyan-investigating-powershell-attacks.pdf)
